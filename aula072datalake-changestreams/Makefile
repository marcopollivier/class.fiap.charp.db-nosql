# Makefile para Data Lake com Change Streams

.PHONY: help up down logs clean init-replica sample-data check-datalake run

help: ## Mostra este menu de ajuda
	@echo "Comandos disponÃ­veis:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

up: ## Sobe o MongoDB Replica Set
	@echo "ğŸš€ Subindo MongoDB Replica Set..."
	docker-compose up -d
	@echo "â³ Aguardando MongoDB inicializar..."
	@sleep 10
	@make init-replica
	@echo "âœ… MongoDB Replica Set configurado!"

down: ## Para todos os serviÃ§os
	@echo "ğŸ›‘ Parando serviÃ§os..."
	docker-compose down

logs: ## Mostra logs dos serviÃ§os
	docker-compose logs -f

clean: ## Remove todos os containers e volumes
	@echo "ğŸ§¹ Limpando ambiente..."
	docker-compose down -v --remove-orphans
	docker system prune -f

init-replica: ## Inicializa o Replica Set
	@echo "ğŸ”§ Configurando Replica Set..."
	@sleep 5
	docker exec mongodb-primary mongosh --username admin --password admin123 --authenticationDatabase admin --eval "
		rs.initiate({
			_id: 'rs0',
			members: [
				{ _id: 0, host: 'mongodb-primary:27017' },
				{ _id: 1, host: 'mongodb-secondary:27017' }
			]
		})
	"
	@echo "â³ Aguardando estabilizaÃ§Ã£o do Replica Set..."
	@sleep 10

sample-data: ## Insere dados de exemplo
	@echo "ğŸ“¦ Inserindo dados de exemplo..."
	docker exec mongodb-primary mongosh --username admin --password admin123 --authenticationDatabase admin datalake_demo --file /docker-entrypoint-initdb.d/sample-data.js
	@echo "âœ… Dados de exemplo inseridos!"

check-datalake: ## Verifica dados no Data Lake
	@echo "ğŸ“Š Verificando Data Lake..."
	docker exec mongodb-primary mongosh --username admin --password admin123 --authenticationDatabase admin datalake_demo --eval "
		print('=== DADOS OPERACIONAIS ===');
		print('Clientes:', db.clientes.countDocuments());
		print('Pedidos:', db.pedidos.countDocuments());
		print('Itens:', db.itens.countDocuments());
		print('');
		print('=== DATA LAKE ===');
		print('Eventos processados:', db.datalake.countDocuments());
		print('');
		print('=== ÃšLTIMOS EVENTOS ===');
		db.datalake.find().sort({timestamp: -1}).limit(3).forEach(doc => {
			print(JSON.stringify(doc, null, 2));
		});
	"

run: ## Executa a aplicaÃ§Ã£o .NET
	@echo "ğŸƒ Executando aplicaÃ§Ã£o Data Lake Processor..."
	cd DataLakeProcessor && dotnet run

build: ## Compila a aplicaÃ§Ã£o
	@echo "ğŸ”¨ Compilando aplicaÃ§Ã£o..."
	cd DataLakeProcessor && dotnet build

restore: ## Restaura dependÃªncias
	@echo "ğŸ“¦ Restaurando dependÃªncias..."
	cd DataLakeProcessor && dotnet restore

test-connection: ## Testa conexÃ£o com MongoDB
	@echo "ğŸ” Testando conexÃ£o..."
	docker exec mongodb-primary mongosh --username admin --password admin123 --authenticationDatabase admin --eval "
		rs.status()
	"