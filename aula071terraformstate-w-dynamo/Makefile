# Makefile para automaÃ§Ã£o dos comandos Terraform
# Uso: make <target>

.PHONY: help init plan apply destroy clean fmt validate show output state-list

# VariÃ¡veis padrÃ£o
BUCKET_NAME ?= terraform-state-fiap-nosql-$(USER)
TABLE_NAME ?= terraform-state-lock
AWS_REGION ?= us-east-1

# Ajuda
help: ## Mostrar esta ajuda
	@echo "Comandos disponÃ­veis:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# Verificar prÃ©-requisitos
check-prereqs: ## Verificar se as ferramentas necessÃ¡rias estÃ£o instaladas
	@echo "Verificando prÃ©-requisitos..."
	@command -v terraform >/dev/null 2>&1 || { echo >&2 "Terraform nÃ£o estÃ¡ instalado. Aborting."; exit 1; }
	@command -v aws >/dev/null 2>&1 || { echo >&2 "AWS CLI nÃ£o estÃ¡ instalado. Aborting."; exit 1; }
	@aws sts get-caller-identity >/dev/null 2>&1 || { echo >&2 "AWS nÃ£o estÃ¡ configurado. Execute 'aws configure'. Aborting."; exit 1; }
	@echo "âœ… Todos os prÃ©-requisitos atendidos"

# Criar recursos AWS necessÃ¡rios para o backend
create-backend: check-prereqs ## Criar bucket S3 e tabela DynamoDB para o backend
	@echo "Criando bucket S3: $(BUCKET_NAME)"
	@aws s3 mb s3://$(BUCKET_NAME) --region $(AWS_REGION) || echo "Bucket jÃ¡ existe ou erro na criaÃ§Ã£o"
	@echo "Habilitando versionamento no bucket..."
	@aws s3api put-bucket-versioning --bucket $(BUCKET_NAME) --versioning-configuration Status=Enabled
	@echo "Criando tabela DynamoDB: $(TABLE_NAME)"
	@aws dynamodb create-table \
		--table-name $(TABLE_NAME) \
		--attribute-definitions AttributeName=LockID,AttributeType=S \
		--key-schema AttributeName=LockID,KeyType=HASH \
		--provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
		--region $(AWS_REGION) || echo "Tabela jÃ¡ existe ou erro na criaÃ§Ã£o"
	@echo "âœ… Backend configurado com sucesso"

# Verificar se terraform.tfvars existe
check-tfvars:
	@if [ ! -f terraform.tfvars ]; then \
		echo "âŒ Arquivo terraform.tfvars nÃ£o encontrado"; \
		echo "Copie terraform.tfvars.example para terraform.tfvars e configure os valores:"; \
		echo "cp terraform.tfvars.example terraform.tfvars"; \
		exit 1; \
	fi

# Inicializar Terraform
init: check-prereqs check-tfvars ## Inicializar Terraform com backend remoto
	@echo "Inicializando Terraform..."
	@terraform init \
		-backend-config="bucket=$(BUCKET_NAME)" \
		-backend-config="key=terraform.tfstate" \
		-backend-config="region=$(AWS_REGION)" \
		-backend-config="dynamodb_table=$(TABLE_NAME)" \
		-backend-config="encrypt=true"
	@echo "âœ… Terraform inicializado"

# Planejar mudanÃ§as
plan: ## Mostrar plano de execuÃ§Ã£o
	@echo "Gerando plano de execuÃ§Ã£o..."
	@terraform plan -out=tfplan
	@echo "âœ… Plano gerado. Execute 'make apply' para aplicar"

# Aplicar mudanÃ§as
apply: ## Aplicar mudanÃ§as na infraestrutura
	@echo "Aplicando mudanÃ§as na infraestrutura..."
	@if [ -f tfplan ]; then \
		terraform apply tfplan; \
	else \
		terraform apply; \
	fi
	@rm -f tfplan
	@echo "âœ… Infraestrutura aplicada com sucesso"

# Destruir infraestrutura
destroy: ## Destruir toda a infraestrutura
	@echo "âš ï¸  ATENÃ‡ÃƒO: Isso irÃ¡ destruir TODA a infraestrutura!"
	@echo "Digite 'yes' para confirmar ou Ctrl+C para cancelar"
	@read -r CONFIRM
	@terraform destroy
	@echo "âœ… Infraestrutura destruÃ­da"

# Mostrar outputs
output: ## Mostrar outputs da infraestrutura
	@terraform output

# Mostrar estado atual
show: ## Mostrar estado detalhado da infraestrutura
	@terraform show

# Listar recursos no state
state-list: ## Listar todos os recursos no state
	@terraform state list

# Formatar arquivos
fmt: ## Formatar arquivos Terraform
	@echo "Formatando arquivos Terraform..."
	@terraform fmt -recursive
	@echo "âœ… Arquivos formatados"

# Validar configuraÃ§Ã£o
validate: ## Validar configuraÃ§Ã£o Terraform
	@echo "Validando configuraÃ§Ã£o..."
	@terraform validate
	@echo "âœ… ConfiguraÃ§Ã£o vÃ¡lida"

# Limpeza
clean: ## Limpar arquivos temporÃ¡rios
	@echo "Limpando arquivos temporÃ¡rios..."
	@rm -f tfplan
	@rm -f *.log
	@rm -f *.tmp
	@echo "âœ… Limpeza concluÃ­da"

# Workflow completo para primeira execuÃ§Ã£o
first-run: check-prereqs create-backend init plan ## Workflow completo para primeira execuÃ§Ã£o
	@echo "ğŸ‰ Pronto para aplicar! Execute 'make apply' para criar a infraestrutura"

# Comando de desenvolvimento rÃ¡pido
dev: fmt validate plan ## Workflow de desenvolvimento (format + validate + plan)

# Mostrar informaÃ§Ãµes Ãºteis
info: ## Mostrar informaÃ§Ãµes do ambiente
	@echo "=== InformaÃ§Ãµes do Ambiente ==="
	@echo "AWS Account ID: $$(aws sts get-caller-identity --query Account --output text)"
	@echo "AWS Region: $$(aws configure get region)"
	@echo "AWS User: $$(aws sts get-caller-identity --query Arn --output text)"
	@echo "Terraform Version: $$(terraform version -json | jq -r .terraform_version)"
	@echo "Bucket Name: $(BUCKET_NAME)"
	@echo "DynamoDB Table: $(TABLE_NAME)"
	@echo "================================"

# Verificar backend
check-backend: ## Verificar se o backend estÃ¡ funcionando
	@echo "Verificando bucket S3..."
	@aws s3 ls s3://$(BUCKET_NAME) || echo "âŒ Erro ao acessar bucket"
	@echo "Verificando tabela DynamoDB..."
	@aws dynamodb describe-table --table-name $(TABLE_NAME) --region $(AWS_REGION) >/dev/null || echo "âŒ Erro ao acessar tabela DynamoDB"
	@echo "âœ… Backend verificado"