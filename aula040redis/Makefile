# Makefile para Aula 04 - Redis

.PHONY: help up down clean build run test logs redis-cli docs

help: ## Mostra esta ajuda
	@echo "Comandos disponÃ­veis:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

up: ## Sobe a infraestrutura Redis
	docker-compose up -d
	@echo "âœ… Redis rodando em localhost:6379"
	@echo "ğŸ“š Material didÃ¡tico em: ./doc/"
	@echo "ğŸš€ Para rodar a API: make run"

down: ## Para e remove os containers
	docker-compose down

clean: ## Para containers e remove volumes
	docker-compose down -v
	docker system prune -f

build: ## Compila o projeto .NET
	dotnet build RedisExamplesApi.csproj

run: ## Executa a aplicaÃ§Ã£o .NET (certifique-se de que Redis esteja rodando)
	@echo "ğŸš€ Iniciando aplicaÃ§Ã£o..."
	@echo "ğŸ“– Swagger UI: http://localhost:5000"
	@echo "â¤ï¸  Health Check: http://localhost:5000/health"
	dotnet run --project RedisExamplesApi.csproj

test: ## Executa testes bÃ¡sicos no Redis
	@echo "ğŸ§ª Testando conectividade com Redis..."
	docker exec -it aula04-redis redis-cli -a password123 ping
	@echo "ğŸ“Š InformaÃ§Ãµes do Redis:"
	docker exec -it aula04-redis redis-cli -a password123 info server

redis-cli: ## Abre o Redis CLI
	@echo "ğŸ”§ Conectando ao Redis CLI..."
	@echo "ğŸ’¡ Dica: Use 'exit' para sair"
	docker exec -it aula04-redis redis-cli -a password123

logs: ## Mostra logs dos containers
	docker-compose logs -f

docs: ## Abre a documentaÃ§Ã£o no navegador (se disponÃ­vel)
	@echo "ğŸ“š Material didÃ¡tico disponÃ­vel em:"
	@echo "  - ./doc/README.md (Ã­ndice principal)"
	@echo "  - ./doc/01-introducao-redis.md"
	@echo "  - ./doc/02-tipos-dados.md"
	@echo "  - ./doc/03-cache-distribuido.md"
	@echo "  - ./doc/04-persistencia.md"
	@echo "  - ./doc/05-casos-uso-avancados.md"
	@echo "  - ./doc/06-resumo-melhores-praticas.md"

# Comandos de exemplo para demonstraÃ§Ã£o
exemplo-cache: ## Testa cache bÃ¡sico via curl
	@echo "ğŸ§ª Testando cache de produto..."
	curl -s "http://localhost:5000/api/redisexamples/cache-produto/123" | jq .

exemplo-contador: ## Testa contador de visitas
	@echo "ğŸ§ª Incrementando visitas..."
	curl -X POST "http://localhost:5000/api/redisexamples/incrementar-visitas/123"

exemplo-leaderboard: ## Testa leaderboard
	@echo "ğŸ§ª Adicionando pontuaÃ§Ã£o..."
	curl -X POST -H "Content-Type: application/json" \
		-d '{"jogador":"Player1","pontos":1500}' \
		"http://localhost:5000/api/redisexamples/leaderboard"
	@echo "\nğŸ† Top 10:"
	curl -s "http://localhost:5000/api/redisexamples/leaderboard/top/10" | jq .

status: ## Mostra status da infraestrutura
	@echo "ğŸ“Š Status dos containers:"
	docker-compose ps
	@echo "\nâ¤ï¸  Health check da aplicaÃ§Ã£o:"
	curl -s http://localhost:5000/health | jq . || echo "API nÃ£o estÃ¡ rodando"

quick-start: up ## InÃ­cio rÃ¡pido - sobe tudo e mostra prÃ³ximos passos
	@sleep 3
	@echo "\nğŸ‰ Ambiente pronto!"
	@echo "\nğŸ“š Para estudar:"
	@echo "  make docs         # Ver material didÃ¡tico"
	@echo "\nğŸš€ Para executar:"
	@echo "  make run          # Iniciar API .NET"
	@echo "\nğŸ§ª Para testar:"
	@echo "  make redis-cli    # Conectar ao Redis"
	@echo "  make exemplo-*    # Executar exemplos"
	@echo "\nğŸ“Š Para monitorar:"
	@echo "  make status       # Ver status geral"
	@echo "  make logs         # Ver logs"
