.PHONY: up down clean logs status setup-sharding mongo-shell

# ConfiguraÃ§Ã£o principal
up:
	@echo "ğŸš€ Iniciando MongoDB Sharded Cluster..."
	docker compose up -d
	@echo "â³ Aguardando inicializaÃ§Ã£o dos containers..."
	sleep 10
	@echo "âœ… Cluster iniciado! Execute 'make setup-sharding' para configurar o sharding"

# Parar containers
down:
	@echo "ğŸ›‘ Parando MongoDB Sharded Cluster..."
	docker compose down

# Limpeza completa
clean:
	@echo "ğŸ§¹ Limpando volumes e containers..."
	docker compose down -v
	docker system prune -f

# Ver logs
logs:
	docker compose logs -f

# Status dos containers
status:
	docker compose ps

# Configurar sharding (executar apÃ³s 'make up')
setup-sharding:
	@echo "âš™ï¸ Configurando Config Server Replica Set..."
	-docker exec -it configsvr1 mongosh --eval "rs.initiate({_id: 'configrs', configsvr: true, members: [{_id: 0, host: 'configsvr1:27017'}, {_id: 1, host: 'configsvr2:27017'}, {_id: 2, host: 'configsvr3:27017'}]})"
	@echo "â³ Aguardando Config Server..."
	sleep 15
	
	@echo "âš™ï¸ Configurando Shard 1 Replica Set..."
	-docker exec -it shard1srv mongosh --eval "rs.initiate({_id: 'shard1rs', members: [{_id: 0, host: 'shard1srv:27017'}]})"
	sleep 5
	
	@echo "âš™ï¸ Configurando Shard 2 Replica Set..."
	-docker exec -it shard2srv mongosh --eval "rs.initiate({_id: 'shard2rs', members: [{_id: 0, host: 'shard2srv:27017'}]})"
	sleep 5
	
	@echo "âš™ï¸ Configurando Shard 3 Replica Set..."
	-docker exec -it shard3srv mongosh --eval "rs.initiate({_id: 'shard3rs', members: [{_id: 0, host: 'shard3srv:27017'}]})"
	sleep 10
	
	@echo "ğŸ”— Adicionando shards ao cluster..."
	-docker exec -it mongos mongosh --eval "sh.addShard('shard1rs/shard1srv:27017')"
	-docker exec -it mongos mongosh --eval "sh.addShard('shard2rs/shard2srv:27017')"
	-docker exec -it mongos mongosh --eval "sh.addShard('shard3rs/shard3srv:27017')"
	
	@echo "ğŸ“Š Habilitando sharding no banco 'pedidos'..."
	-docker exec -it mongos mongosh --eval "sh.enableSharding('pedidos')"
	
	@echo "ğŸ”‘ Configurando shard key na coleÃ§Ã£o 'clientes'..."
	-docker exec -it mongos mongosh --eval "use pedidos; db.clientes.createIndex({'primeiraLetra': 1})"
	-docker exec -it mongos mongosh --eval "sh.shardCollection('pedidos.clientes', {'primeiraLetra': 1})"
	
	@echo "âœ… Sharding configurado! Verificando status..."
	docker exec -it mongos mongosh --eval "sh.status()"

# Conectar ao mongos via shell
mongo-shell:
	@echo "ğŸš Conectando ao Mongos Router..."
	docker exec -it mongos mongosh

# Verificar distribuiÃ§Ã£o de dados
check-distribution:
	@echo "ğŸ“Š Verificando distribuiÃ§Ã£o de dados..."
	docker exec -it mongos mongosh --eval "use pedidos; db.clientes.getShardDistribution()"

# Inserir dados de teste
test-data:
	@echo "ğŸ“ Inserindo dados de teste..."
	docker exec -it mongos mongosh --eval "use pedidos; db.clientes.insertMany([{nome: 'Ana Silva', email: 'ana@teste.com', primeiraLetra: 'A'}, {nome: 'Bruno Costa', email: 'bruno@teste.com', primeiraLetra: 'B'}, {nome: 'Igor Santos', email: 'igor@teste.com', primeiraLetra: 'I'}, {nome: 'Julia Lima', email: 'julia@teste.com', primeiraLetra: 'J'}, {nome: 'Roberto Alves', email: 'roberto@teste.com', primeiraLetra: 'R'}, {nome: 'Sofia Oliveira', email: 'sofia@teste.com', primeiraLetra: 'S'}])"
	@echo "âœ… Dados inseridos! Execute 'make check-distribution' para ver a distribuiÃ§Ã£o"

# Help
help:
	@echo "ğŸ“š Comandos disponÃ­veis:"
	@echo "  make up              - Iniciar cluster"
	@echo "  make setup-sharding  - Configurar sharding (apÃ³s up)"
	@echo "  make test-data       - Inserir dados de teste"
	@echo "  make check-distribution - Ver distribuiÃ§Ã£o dos dados"
	@echo "  make mongo-shell     - Conectar ao mongos"
	@echo "  make logs           - Ver logs dos containers"
	@echo "  make status         - Status dos containers"
	@echo "  make down           - Parar cluster"
	@echo "  make clean          - Limpeza completa"