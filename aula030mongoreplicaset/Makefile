# Makefile para MongoDB Replica Set

.PHONY: up down clean restart status data check-replication test-app

# Subir ambiente
up:
	@echo "ğŸ“¦ Subindo MongoDB Replica Set..."
	docker compose up -d
	@sleep 8
	@./configure-replica-set.sh

# Parar ambiente
down:
	docker compose down

# Limpar tudo
clean:
	docker compose down -v

# Restart completo
restart: clean up

# Ver status do replica set
status:
	@docker exec mongo-primary mongosh --eval 'rs.status()' 2>/dev/null || echo "âŒ Containers nÃ£o rodando"

# Ver dados
data:
	@docker exec mongo-primary mongosh pedidos --eval 'db.clientes.find().pretty()' 2>/dev/null || echo "âŒ Sem dados"

# Verificar replicaÃ§Ã£o em todos os nÃ³s
check-replication:
	@echo "ğŸ” Verificando replicaÃ§Ã£o em todos os nÃ³s:"
	@echo "\nğŸ“Š PRIMARY (27017):"
	@docker exec mongo-primary mongosh pedidos --eval 'db.clientes.find().count()' 2>/dev/null || echo "âŒ Erro"
	@echo "\nğŸ“Š SECONDARY 1 (27018):"
	@docker exec mongo-secondary1 mongosh pedidos --eval 'rs.secondaryOk(); db.clientes.find().count()' 2>/dev/null || echo "âŒ Erro"
	@echo "\nğŸ“Š SECONDARY 2 (27019):"
	@docker exec mongo-secondary2 mongosh pedidos --eval 'rs.secondaryOk(); db.clientes.find().count()' 2>/dev/null || echo "âŒ Erro"
	@echo "\nâš™ï¸  Status dos membros:"
	@docker exec mongo-primary mongosh --eval 'rs.status()' 2>/dev/null | grep -E "(name|stateStr|health)" || echo "âŒ Erro"

# Executar aplicaÃ§Ã£o .NET
test-app:
	@echo "ğŸš€ Executando aplicaÃ§Ã£o .NET..."
	cd PedidosApiSimples && dotnet run
